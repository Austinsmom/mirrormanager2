#!/usr/bin/python

import os, sys
from os.path import join
import pickle
import bz2
import re

def usage():
    print "No output file or directories specified"
    sys.exit(1)

def print_iso_sizes(dirtree):
    for d in dirtree:
        dir = d['dirpath']
        files = d['files']
        for f in files.iterkeys():
            if re.compile("\.iso$").search(f, 1):
                print "%s %s" % (os.path.join(dir, f), files[f])



from optparse import OptionParser
parser = OptionParser(usage= sys.argv[0] + " [options] dir1 [dir2] ...")
parser.add_option("-o", "--output",
                  dest="output",
                  default=None,
                  help="Output filename (required)")

(options, args) = parser.parse_args()
if len(args) < 1:
    usage()
if options.output is None:
    usage()

# structure here is:
# dirtree is a list
# [
#   { 'dirpath' : dirpath,
#     'files'   : {
#                   filename1 : size1,
#                   filename2 : size2,
#                   ...
#                 }
#   }
#   ...
# ]
# 

dirtree = []

for a in args:
    for dirpath, dirnames, filenames in os.walk(a):
        result = {'dirpath': dirpath}

        statfiles = {}
        for name in filenames:
            f = os.path.join(dirpath, name)
            s = os.stat(f)
            statfiles[name] = s.st_size

        result['files'] = statfiles
        dirtree.append(result)
        #print '%s size=%s time=%s' % (f, s.st_size, s.st_ctime)


print_iso_sizes(dirtree)
pbz = bz2.compress(pickle.dumps(dirtree, -1))
outfile = open(options.output, 'wb')
outfile.write(pbz)
outfile.close()
